<!-- HTML for custom Swagger UI page -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>API Documentation</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="https://unpkg.com/swagger-ui-dist@4.5.0/swagger-ui.css"
    />
    <style>
      html {
        box-sizing: border-box;
        overflow: -moz-scrollbars-vertical;
        overflow-y: scroll;
      }

      *,
      *:before,
      *:after {
        box-sizing: inherit;
      }

      body {
        margin: 0;
        background: #fafafa;
      }

      .swagger-ui .topbar {
        background-color: #1f2937;
      }

      .swagger-ui .info .title {
        color: #1f2937;
      }

      .auth-notification {
        position: fixed;
        top: 10px;
        right: 10px;
        padding: 15px;
        background-color: #4caf50;
        color: white;
        border-radius: 4px;
        z-index: 9999;
        display: none;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }

      .auth-notification.show {
        display: block;
        animation: fadeOut 3s forwards;
        animation-delay: 2s;
      }

        .auth-btn-wrapper {
        justify-content: space-between !important;
      }

      @keyframes fadeOut {
        from {
          opacity: 1;
        }
        to {
          opacity: 0;
        }
      }
    </style>
  </head>
  <body>
    <div id="swagger-ui"></div>
    <div id="auth-notification" class="auth-notification">
      Authentication successful! Token applied to all requests.
    </div>

    <script src="https://unpkg.com/swagger-ui-dist@4.5.0/swagger-ui-bundle.js"></script>
    <script src="https://unpkg.com/swagger-ui-dist@4.5.0/swagger-ui-standalone-preset.js"></script>
    <script>
      window.onload = function () {
        // Begin Swagger UI call region
        const ui = SwaggerUIBundle({
          url: "/api-docs.json",
          dom_id: "#swagger-ui",
          deepLinking: true,
          presets: [SwaggerUIBundle.presets.apis, SwaggerUIStandalonePreset],
          plugins: [SwaggerUIBundle.plugins.DownloadUrl],
          layout: "StandaloneLayout",
          persistAuthorization: true,
          docExpansion: "none",
          filter: true,
          tagsSorter: "alpha",
          operationsSorter: "alpha",
          onComplete: function () {
            // Add a custom script to handle login responses
            const loginEndpoint = document.querySelector('.opblock-tag-section[data-tag="Users"]');
            if (loginEndpoint) {
              // Wait for the DOM to be fully loaded
              setTimeout(() => {
                // Find all operation blocks
                const operations = loginEndpoint.querySelectorAll(".opblock");

                // Find the login operation
                let loginOperation;
                for (const op of operations) {
                  const path = op.querySelector(".opblock-summary-path");
                  if (path && path.textContent.includes("/api/users/login")) {
                    loginOperation = op;
                    break;
                  }
                }

                if (loginOperation) {
                  // Find the Execute button
                  const executeButton = loginOperation.querySelector(".execute");
                  if (executeButton) {
                    // Add a click event listener
                    executeButton.addEventListener("click", function () {
                      // Wait for the response
                      setTimeout(() => {
                        // Find the response body
                        const responseBody = loginOperation.querySelector(".highlight-code");
                        if (responseBody) {
                          try {
                            // Parse the response
                            const responseText = responseBody.textContent;
                            const response = JSON.parse(responseText);

                            // Check if the response contains an access token
                            if (response.data && response.data.accessToken) {
                              const token = response.data.accessToken;

                              // Set the bearer token in Swagger UI
                              ui.authActions.authorize({
                                bearerAuth: {
                                  name: "bearerAuth",
                                  schema: {
                                    type: "http",
                                    scheme: "bearer",
                                    bearerFormat: "JWT",
                                  },
                                  value: token,
                                },
                              });

                              // Show notification
                              const notification = document.getElementById("auth-notification");
                              notification.classList.add("show");

                              // Remove notification after animation completes
                              setTimeout(() => {
                                notification.classList.remove("show");
                              }, 5000);
                            }
                          } catch (e) {
                            console.error("Error parsing response:", e);
                          }
                        }
                      }, 1000); // Wait 1 second for the response to be displayed
                    });
                  }
                }
              }, 1000); // Wait 1 second for the DOM to be fully loaded
            }
          },
        });
        // End Swagger UI call region

        // Listen for the custom event from the response interceptor
        window.addEventListener("swaggerAuthorization", function (event) {
          const token = event.detail.token;

          // Set the bearer token in Swagger UI
          ui.authActions.authorize({
            bearerAuth: {
              name: "bearerAuth",
              schema: {
                type: "http",
                scheme: "bearer",
                bearerFormat: "JWT",
              },
              value: token,
            },
          });

          // Show notification
          const notification = document.getElementById("auth-notification");
          notification.classList.add("show");

          // Remove notification after animation completes
          setTimeout(() => {
            notification.classList.remove("show");
          }, 5000);
        });

        window.ui = ui;
      };
    </script>
  </body>
</html>
